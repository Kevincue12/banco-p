<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donar al Banco de Alimentos</title>
    <link rel="stylesheet" href="/static/estilos.css">
</head>
<body>
    <!-- Bot√≥n para volver al inicio -->
    <a href="/"><button class="btn">üè† Volver al Inicio</button></a>

    <header>
        <nav class="nav">
            <h2 class="logo">üçé Donaciones</h2>
            <ul>
                <li><a href="/">Inicio</a></li>
                <li><a href="/banco">Administrador Banco</a></li>
                <li><a href="/bancos">Ver Bancos</a></li>
            </ul>
        </nav>
    </header>

    <section class="form-section">
        <h2>Registrar Donaci√≥n</h2>

        <!-- Paso 1: Datos de la donaci√≥n -->
        <form id="form-donante">
            <input type="text" placeholder="Tu nombre" id="nombre" required>

            <div id="items-container">
                <div class="item">
                    <select class="tipo" required>
                        <option value="">Seleccionar categor√≠a</option>
                        <option value="frutas">Frutas</option>
                        <option value="granos">Granos</option>
                        <option value="enlatados">Enlatados</option>
                    </select>
                    <input type="number" class="cantidad" placeholder="Cantidad" required>
                </div>
            </div>

            <button type="button" class="btn btn-secondary" onclick="agregarItem()">‚ûï Agregar otro √≠tem</button>
            <button type="submit" class="btn btn-primary">Buscar Bancos Disponibles</button>
            <button type="button" class="btn btn-success" onclick="confirmarLoteGreedy()">Asignar autom√°ticamente (Greedy)</button>
        </form>

        <!-- Paso 2: Mostrar bancos disponibles -->
        <div id="bancos-disponibles"></div>

        <!-- Paso 3: Confirmaci√≥n -->
        <div id="respuesta-donante" class="mensaje-creativo"></div>
    </section>

    <script>
    // Agregar m√°s √≠tems al formulario
    function agregarItem() {
        const container = document.getElementById("items-container");
        const div = document.createElement("div");
        div.classList.add("item");
        div.innerHTML = `
            <select class="tipo" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="frutas">Frutas</option>
                <option value="granos">Granos</option>
                <option value="enlatados">Enlatados</option>
            </select>
            <input type="number" class="cantidad" placeholder="Cantidad" required>
        `;
        container.appendChild(div);
    }

    // Paso 1: Buscar bancos disponibles para el lote
    document.getElementById("form-donante").addEventListener("submit", async function(e) {
        e.preventDefault();

        const nombre = document.getElementById("nombre").value;
        const items = [];
        document.querySelectorAll("#items-container .item").forEach(div => {
            const tipo = div.querySelector(".tipo").value;
            const cantidad = parseInt(div.querySelector(".cantidad").value);
            items.push({ tipo, cantidad });
        });

        try {
            const res = await fetch("/donar/opciones/lote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nombre: nombre, donaciones: items })
            });

            const bancos = await res.json();

            if (bancos.length === 0) {
                document.getElementById("bancos-disponibles").innerHTML =
                    "<p>No hay bancos con espacio suficiente para estas donaciones.</p>";
                return;
            }

            let lista = "<h3>Bancos disponibles:</h3><ul>";
            bancos.forEach(b => {
                lista += `
                    <li>
                        <strong>${b.nombre}</strong> - ${b.direccion}
                        <button class="btn btn-secondary" onclick="confirmarLote('${nombre}', ${b.id})">
                            Donar aqu√≠
                        </button>
                    </li>`;
            });
            lista += "</ul>";
            document.getElementById("bancos-disponibles").innerHTML = lista;

        } catch (error) {
            document.getElementById("respuesta-donante").innerText = "Error de conexi√≥n con el servidor";
        }
    });

    // Paso 2: Confirmar lote en banco elegido manualmente
    async function confirmarLote(nombre, bancoId) {
        const items = [];
        document.querySelectorAll("#items-container .item").forEach(div => {
            const tipo = div.querySelector(".tipo").value;
            const cantidad = parseInt(div.querySelector(".cantidad").value);
            items.push({ tipo, cantidad });
        });

        try {
            const res = await fetch("/donar/lote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    nombre: nombre,
                    banco_id: bancoId,
                    donaciones: items
                })
            });

            const data = await res.json();
            document.getElementById("respuesta-donante").innerText = data.mensaje || "Error al registrar donaci√≥n";

            if (data.mensaje && data.mensaje.includes("Lote de donaciones registrado")) {
                setTimeout(() => {
                    window.location.href = "/";
                }, 2000);
            }
        } catch (error) {
            document.getElementById("respuesta-donante").innerText = "Error de conexi√≥n con el servidor";
        }
    }

    // Paso 3: Confirmar lote autom√°ticamente con algoritmo Greedy (versi√≥n creativa)
    async function confirmarLoteGreedy() {
        const nombre = document.getElementById("nombre").value;
        const items = [];
        document.querySelectorAll("#items-container .item").forEach(div => {
            const tipo = div.querySelector(".tipo").value;
            const cantidad = parseInt(div.querySelector(".cantidad").value);
            items.push({ tipo, cantidad });
        });

        try {
            const res = await fetch("/donar/greedy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    nombre: nombre,
                    donaciones: items
                })
            });

            const data = await res.json();
            let salida = "<h3>‚ú® Distribuci√≥n de tus donaciones ‚ú®</h3>";
            data.resultados.forEach(r => {
                if (r.banco) {
                    salida += `<p>üõí Tus <strong>${r.cantidad} ${r.tipo}</strong> fueron enviados al <strong>${r.banco}</strong> en ${r.direccion}, listos para ayudar a muchas familias.</p>`;
                } else {
                    salida += `<p>‚ö†Ô∏è Los <strong>${r.cantidad} ${r.tipo}</strong> no pudieron ser asignados: ${r.mensaje}.</p>`;
                }
            });
            document.getElementById("respuesta-donante").innerHTML = salida;

        } catch (error) {
            document.getElementById("respuesta-donante").innerText = "Error de conexi√≥n con el servidor";
        }
    }
    </script>
</body>
</html>